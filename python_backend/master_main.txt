
@app.post("/api/events/{id}/payment", response_model=Event)
async def record_payment(id: str, payload: PaymentRequest):
    event = await db.events.find_one({"_id": ObjectId(id)})
    if not event: raise HTTPException(status_code=404, detail="Event not found")
    
    new_paid = (event.get("paidAmount") or 0) + payload.amount
    total = event.get("price") or 0
    status = "paid" if new_paid >= total and total > 0 else ("partial" if new_paid > 0 else "pending")
    
    # Create Payment Record
    payment_record = PaymentRecord(
        id=str(uuid.uuid4()),
        amount=payload.amount,
        date=payload.date or datetime.now()
    )
    
    await db.events.update_one(
        {"_id": ObjectId(id)}, 
        {
            "$set": {"paidAmount": new_paid, "paymentStatus": status},
            "$push": {"paymentHistory": payment_record.model_dump()}
        }
    )
    return await db.events.find_one({"_id": ObjectId(id)})
