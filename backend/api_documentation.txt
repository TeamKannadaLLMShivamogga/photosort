
# PhotoSort Pro - System API Documentation

This document outlines the architecture and API specification for the PhotoSort Pro application.
The system is composed of two Python FastAPI services and a React frontend.

---

## 1. System Architecture

### A. Master Backend Service
*   **Port:** `8000`
*   **Framework:** Python FastAPI
*   **Role:** Core business logic, database management, file storage, user authentication, and orchestration.
*   **Static Files:** Serves uploaded images via `/uploads` path (mapped to local `uploads/` directory).

### B. Gen AI Service
*   **Port:** `8001`
*   **Framework:** Python FastAPI
*   **Role:** Asynchronous image processing, metadata generation, face detection, and smart tagging using Vision Language Models (Qwen-VL) or mock engines.

### C. Database
*   **Type:** MongoDB
*   **Connection:** Both services connect to the same MongoDB instance (`photosort` database).

---

## 2. Data Models (Pydantic)

### User
```python
class User(BaseModel):
    id: str                 # MongoDB ObjectId
    email: str              # Unique
    name: str
    phone: Optional[str]    # Mobile number for lookup
    role: 'ADMIN' | 'PHOTOGRAPHER' | 'USER'
    avatar: str
    familyMembers: List[FamilyMember]
    subscriptionTier: 'FREE' | 'PRO' | 'STUDIO'
    isActive: bool
```

### Event
```python
class Event(BaseModel):
    id: str
    name: str
    date: datetime
    photographerId: str     # Reference to User
    coverImage: str
    photoCount: int
    assignedUsers: List[str] # List of User IDs who have access
    subEvents: List[SubEvent]
    status: 'active' | 'completed' | 'closed'
    price: float
    paidAmount: float
    paymentStatus: 'pending' | 'partial' | 'paid'
    plan: 'BASIC' | 'STANDARD' | 'PRO'
```

### Photo
```python
class Photo(BaseModel):
    id: str
    url: str                # Relative path (e.g., "/uploads/event_id/image.jpg")
    eventId: str
    tags: List[str]
    people: List[str]
    isAiPick: bool
    quality: 'high' | 'medium' | 'low'
    category: str
    isSelected: bool
    isAiProcessed: bool     # Flag for AI service status
    aiAnalysis: Dict        # Detailed JSON from AI Service
```

---

## 3. Master Backend Endpoints (Port 8000)

**Base URL:** `http://localhost:8000/api`

### Authentication
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `POST` | `/auth/login` | Login or Register by Email. Returns full User object. |

### User Management
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `GET` | `/users` | List all users. |
| `POST` | `/users` | Create a user manually. |
| `PUT` | `/users/{id}` | Update user profile. |
| `DELETE` | `/users/{id}` | Delete user. |
| `PATCH` | `/users/{id}/status` | Toggle active/inactive status. |

### Event Management
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `GET` | `/events` | List all events. |
| `POST` | `/events` | Create Event. Accepts `initialClients` list to auto-create/assign users. |
| `PUT` | `/events/{id}` | Update event details (payment, status, sub-events). |
| `DELETE` | `/events/{id}` | Delete event and its photos. |
| `POST` | `/events/{id}/assign-user` | **NEW:** Assign a user by Name/Email/Phone. Creates user if not exists. |
| `POST` | `/events/{id}/remove-user` | **NEW:** Remove user access from event. |
| `POST` | `/events/{id}/payment` | Record a payment transaction. |

### Photo Workflow
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `GET` | `/events/{id}/photos` | Get all photos for an event. |
| `POST` | `/events/{id}/photos` | Upload files (Multipart). Saves to disk, creates DB entry, triggers AI. |
| `POST` | `/photos/{id}/selection` | Toggle selection status. |
| `POST` | `/events/{id}/submit-selections`| Finalize selections workflow. |

---

## 4. Gen AI Service Endpoints (Port 8001)

**Base URL:** `http://localhost:8001`

### Processing
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `POST` | `/process-event/{event_id}` | Trigger background AI processing for an event. Scans for `isAiProcessed=False`. |
| `GET` | `/health` | Check service status and GPU availability. |

### Workflow Logic
1.  **Ingestion:** Photos are uploaded to Master Backend. `isAiProcessed` is set to `False`.
2.  **Trigger:** Master Backend calls `POST /process-event/{id}` on Gen AI Service.
3.  **Analysis (Background Task):**
    *   Gen AI Service iterates through unprocessed photos.
    *   Uses Qwen-VL (or Mock) to generate Tags, People, Quality Score, and Categories.
    *   Updates the `Photo` document directly in MongoDB.
    *   Sets `isAiProcessed` to `True`.
4.  **Consumption:** Frontend polls or re-fetches photos to display AI tags.

---

## 5. Frontend Integration Guide

### Proxy Configuration (Vite)
To avoid CORS issues and handle relative paths correctly during development:
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:8000',
    changeOrigin: true,
  },
  '/uploads': {
    target: 'http://localhost:8000',
    changeOrigin: true,
  }
}
```

### Context & State
*   **DataContext:** Centralizes state for `currentUser`, `activeEvent`, `photos`, and `users`.
*   **Optimistic UI:** Selection toggles update local state immediately while sending async requests.
*   **Navigation:**
    *   `Dashboard` -> `Gallery` (via clickable stats).
    *   `EventSelector` -> `Dashboard` (User flow).
    *   `EventSwitcher` component allows switching active event without logging out.

### Key Workflows
1.  **Creating an Event:**
    *   Photographer enters Event Name, Date, Quote.
    *   Adds Client List (Name, Email, Phone).
    *   Backend resolves clients (finds existing or creates new) and links them.
2.  **Uploading Photos:**
    *   Files sent via `FormData`.
    *   Progress bar tracks upload status.
    *   "Indexing" phase waits for AI acknowledgement.
3.  **User Selection:**
    *   User logs in, selects event.
    *   Browses Gallery (filtered by AI tags).
    *   Selects photos -> "Submit for Editing".
